{% extends "layout.html" %}
{% block title %}{{ _('Attendance | List') }}{% endblock %}

{% block head %}
<script>

  $(document).ready(function(){
    new DataTable('#attendancesTbl');
  })
  // Función para enviar el formulario al cambiar el valor de un select
  function submitForm() {
    document.getElementById('filterForm').submit();
  }
  function clearFilters() {
    // Eliminar todos los parámetros de la URL (filtros)
    window.location.href = "{{ url_for('routes.attendances') }}";
  }


</script>

{% endblock %}
{% block content %}
<div class="blog-post">
  <h2><i class="bi bi-clipboard-data"></i> {{ _('Class Attendance Records') }}</h2>
  <div class="col-xl-8">
    <p class="mb-3">
      {{ _("The table shows the attendance recorded each Sunday by members attending classes. Use the information in this list to Record each person's Attendance in the Tools application or <a href='https://lcr.churchofjesuschrist.org/report/class-and-quorum-attendance/overview?lang=spa'>LCR</a>.") | safe }}
    </p>
  </div>
  {% if session['role'] == 'Owner' %}

  {% endif %}
  {% if session['role'] == 'Admin' or session['role'] == 'Owner' %}

  <div class="row g-2 d-flex justify-content-between">

    <div class="col-auto">
      <a class="btn btn-primary col-auto" href="{{ url_for('routes.create_attendance') }}"><i class="bi bi-plus-circle-fill"></i> {{ _('New Attendance') }}</a>
    </div>

    <form class="col-auto" id="verificationForm" method="POST" action="/attendances">
      <div class="form-inline mb-3">
        <label class="my-2 mr-2 col-auto" for="code_verification">{{ _('Lock QR code?') }} </label>
        <select class="custom-select my-1 mr-sm-2" name="code_verification" id="code_verification" data-toggle="tooltip"
          title="Al activar la Verificacion de Domingo, solo se podrá usar la imagen de QR Code impresa para esa semana."
          onchange="submitVerificationForm()">
          <option value="true" {% if verification_enabled=='true' %}selected{% endif %}>{{ _('Yes') }}</option>
          <option value="false" {% if verification_enabled=='false' %}selected{% endif %}>No</option>
        </select>
      </div>

    </form>
  </div>

  {% endif %}
  <div class="mb-5">
    
    <form id="filterForm" method="GET" action="/attendances" class="card mb-3 p-3">

      {% include 'partials/form_filter.html' %}
    </form>
    <!-- Actions Form -->
    <form method="POST" action="/attendances" class="pb-2">
      <table class="table table-striped table-sm" id="attendancesTbl">
        <thead class="thead-dark">
          <tr>
            <th scope="col">#</th>
            <th scope="col">{{ _('Fix') }}</th>
            <th scope="col">{{ _('Member') }}</th>
            <th scope="col">{{ _('Class') }}</th>
            <th scope="col">{{ _('Date') }}</th>
            {% if session['role'] == 'Owner' %}
            <th scope="col">{{ _('Unit') }}</th>
            <th scope="col">{{ _('Code') }}</th>
            {% endif %}
            {% if session['role'] == 'Admin' or session['role'] == 'Owner' %}
            <th scope="col" class="d-none d-md-table-cell">{{ _('Submited') }}</th>
            {% endif %}
            {% if session['role'] == 'Owner' or session['role'] == 'Admin' %}
            <th scope="col">{{ _('Actions') }}</th>
            {% endif %}

          </tr>
        </thead>
        <tbody>
          {% for attendance in attendances %}
          <tr>
            <td scope="row">{{ loop.index }}</td>
            <td>
              {% if attendance.student_name in corrected_names %}
                <input type="checkbox" disabled>
              {% else %}
              <input type="checkbox" data-wrong-name="{{ attendance.student_name }}" 
                     data-meeting-center-id="{{ attendance.meeting_center_id }}" 
                     onclick="correctName(this)">
              {% endif %}
            </td>
            <td style="text-transform:capitalize">{{attendance.student_name}}</td>
            <td>{{_(attendance.class_short_name)}}</td>
            <td>{{ attendance.sunday_date_formatted }}</td>
            {% if session['role'] == 'Owner' %}
            <td>{{_(attendance.meeting_short_name)}}</td>
            <td>{{_(attendance.sunday_code)}}</td>
            {% endif %}
            {% if session['role'] == 'Admin' or session['role'] == 'Owner' %}
            <!-- <td class="d-none d-md-table-cell">{{ attendance.submit_date.strftime("%b %d, %I:%M %p")}}</td> -->
            <td class="d-none d-md-table-cell">{{ format_datetime(attendance.submit_date, format='short') }}</td>

            <td>
              <a type="button" class="btn btn-primary btn-sm"
                href="{{ url_for('routes.update_attendance', id=attendance.id, **request.args.to_dict()) }}"><i
                  class="bi bi-pencil-square"></i></a>

              {% endif %}
              {% if session['role'] == 'Owner' %}
              {% if attendance.id %}
                <form id="deleteForm-attendance-{{ attendance.id }}"
                             action="{{ url_for('routes.delete_attendance', id=attendance.id, **request.args.to_dict()) }}"
                method="post" style="display:inline;">
                <button type="button" class="btn btn-danger btn-sm" data-toggle="tooltip" title="{{ _('Delete attendance') }}"
                  onclick="confirmDelete('attendance', {{ attendance.id }})">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
              {% else %}
              <p>Error: Attendance ID is missing!</p>
            {% endif %}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </form>
    {% if session['role'] == 'Owner' %}
    <form id="deleteAllForm" method="POST" action="/attendances" class="mb-5">
      <input type="hidden" name="delete_all" value="true">
      <button id="delete_all" class="btn btn-danger mb-5" type="button" data-toggle="tooltip"
        title="{{ _('Delete all attendance records in the database') }}" {% if not has_records %}disabled{% endif %}>
        {% if not has_records %}
        {{ _('No Attendances to show') }}
        {% else %}
        <i class="bi bi-eraser-fill"></i> {{ _('Delete all records') }}
        {% endif %}
      </button>
    </form>
    {% endif %}
    <script>
      
      function submitVerificationForm() {
        document.getElementById('verificationForm').submit();
      }
    </script>
     {% endblock %}