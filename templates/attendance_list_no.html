{% extends "layout.html" %}
{% block title %}{{ _('Attendance | List') }}{% endblock %}

{% block head %}
<script>

  // Función para enviar el formulario al cambiar el valor de un select
  function submitForm() {
    document.getElementById('filterForm').submit();
  }
  function clearFilters() {
    // Eliminar todos los parámetros de la URL (filtros)
    window.location.href = "{{ url_for('routes.attendances') }}";
  }

</script>

{% endblock %}

{% block pageTitle %}<i class="bi bi-clipboard-data"></i> {{ _('Attendance Records Management') }}{% endblock %}
{% block content %}
<div class="blog-post">
  <div class="col-xl-8">
    <p class="mb-3">
      {{ _("The table shows the attendance recorded each Sunday by members attending classes. Use the information in this list to Record each person's Attendance in the Tools application or <a href='https://lcr.churchofjesuschrist.org/report/class-and-quorum-attendance/overview?lang=spa'>LCR</a>.") | safe }}
    </p>
  </div>
  {% if session['role'] == 'Owner' %}

  {% endif %}
  {% if session['role'] == 'Admin' or session['role'] == 'Owner' %}

    <div class="col-auto mb-2">
      <a class="btn btn-primary col-auto" href="{{ url_for('routes.create_attendance') }}"><i class="bi bi-plus-circle-fill"></i> {{ _('New Attendance') }}</a>
    </div>

  {% endif %}
  <div class="mb-5">
    
    <form id="filterForm" method="GET" action="/attendance/list" class="card mb-3 p-3">

      {% include 'partials/form_filter.html' %}
    </form>
    <!-- Actions Form -->
    <form method="POST" action="/attendance/list" class="pb-2">
      <!-- Agregar un menú desplegable para seleccionar el número de elementos por página -->
      <label for="per_page">Records per page</label>
      <select id="per_page" name="per_page" onchange="this.form.submit()">
          <option value="10" {% if request.args.get('per_page') == '10' %}selected{% endif %}>10</option>
          <option value="25" {% if request.args.get('per_page') == '25' %}selected{% endif %}>25</option>
          <option value="50" {% if request.args.get('per_page') == '50' %}selected{% endif %}>50</option>
      </select>

      <input type="hidden" name="class_name" value="{{ request.args.get('class_name') }}">
      <input type="hidden" name="student_name" value="{{ request.args.get('student_name') }}">
      <input type="hidden" name="sunday_date" value="{{ request.args.get('sunday_date') }}">

      <!-- Mostrar la lista de asistencias -->
<div id="attendance_table">
  {% include 'partials/attendance_list_table.html' %}
</div>
      <!-- Agregar la paginación -->
      <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if pagination.has_prev %}
                <li class="page-item"><a class="page-link" href="{{ url_for('routes.attendances', page=pagination.prev_num, per_page=pagination.per_page) }}">Previous</a></li>
            {% endif %}
            {% for page_num in pagination.iter_pages() %}
                {% if page_num %}
                    <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('routes.attendances', page=page_num, per_page=pagination.per_page) }}">{{ page_num }}</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">…</span></li>
                {% endif %}
            {% endfor %}
            {% if pagination.has_next %}
                <li class="page-item"><a class="page-link" href="{{ url_for('routes.attendances', page=pagination.next_num, per_page=pagination.per_page) }}">Next</a></li>
            {% endif %}
        </ul>
      </nav>
    </form>
    {% if session['role'] == 'Owner' %}
    <form id="deleteAllForm" method="POST" action="/attendances" class="mb-5">
      <input type="hidden" name="delete_all" value="true">
      <button id="delete_all" class="btn btn-danger mb-5" type="button" data-toggle="tooltip"
        title="{{ _('Delete all attendance records in the database') }}" {% if not has_records %}disabled{% endif %}>
        {% if not has_records %}
        {{ _('No Attendances to show') }}
        {% else %}
        <i class="bi bi-eraser-fill"></i> {{ _('Delete all records') }}
        {% endif %}
      </button>
    </form>
    <!-- Script para manejar la selección de elementos por página -->
<!-- Script para manejar la selección de elementos por página y la paginación -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
      const perPageSelect = document.getElementById('per_page_select');
      const savedPerPage = localStorage.getItem('per_page');

      if (savedPerPage) {
          perPageSelect.value = savedPerPage;
      }

      perPageSelect.addEventListener('change', function() {
          const selectedPerPage = this.value;
          localStorage.setItem('per_page', selectedPerPage);
          loadAttendances(1, selectedPerPage);
      });

      document.getElementById('pagination').addEventListener('click', function(event) {
          event.preventDefault();
          if (event.target.tagName === 'A') {
              const page = event.target.getAttribute('data-page');
              loadAttendances(page, perPageSelect.value);
          }
      });

      function loadAttendances(page, perPage) {
          const url = new URL(window.location.href);
          url.searchParams.set('page', page);
          url.searchParams.set('per_page', perPage);

          // Mantener los filtros actuales
          const studentName = document.getElementById('student_name').value;
          const className   = document.getElementById('class_name').value;
          const sundayDate  = document.getElementById('sunday_date').value;
          const year        = document.getElementById('year').value;
          const month       = document.getElementById('month').value;

          if (studentName) url.searchParams.set('student_name', studentName);
          if (className) url.searchParams.set('class_name', className);
          if (sundayDate) url.searchParams.set('sunday_date', sundayDate);
          if (year) url.searchParams.set('year', year);
          if (month) url.searchParams.set('month', month);

          fetch(url, {
              headers: {
                  'X-Requested-With': 'XMLHttpRequest'
              }
          })
          .then(response => response.json())
          .then(data => {
              // Actualizar la tabla con los nuevos datos
              document.getElementById('attendances_list_table').innerHTML = data.attendances;
              // Actualizar la paginación
              updatePagination(data.pagination);
          });
      }

      function updatePagination(pagination) {
          const paginationElement = document.getElementById('pagination');
          paginationElement.innerHTML = '';

          if (pagination.has_prev) {
              paginationElement.innerHTML += `<li class="page-item"><a class="page-link" href="#" data-page="${pagination.prev_num}">Previous</a></li>`;
          }
          for (let i = 1; i <= pagination.pages; i++) {
              paginationElement.innerHTML += `<li class="page-item ${i === pagination.page ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
          }
          if (pagination.has_next) {
              paginationElement.innerHTML += `<li class="page-item"><a class="page-link" href="#" data-page="${pagination.next_num}">Next</a></li>`;
          }
      }
  });
</script>
    {% endif %}

     {% endblock %}