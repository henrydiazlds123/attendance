{% extends "layout.html" %}

{% block title %}{{ _('Attendance | Report') }}{% endblock %}

{% block pageTitle %}<i class="bi bi-file-earmark-spreadsheet"></i> {{ _('Attendance Report') }}{% endblock %}
{% block content %}

<div class="row">
    <div class="d-flex justify-content-between col-md-12">

        <p>{{ _('Total Members') }}: <b id="total-members">{{ total_miembros }}</b> </p>
        {% if session['role'] == 'Admin' or session['role'] == 'Owner' %}
        
        <div class="col-auto mb-2">
            <a class="btn btn-primary col-auto" href="{{ url_for('routes.create_attendance') }}"><i class="bi bi-plus-circle-fill"></i> {{ _('New Attendance') }}</a>
        </div>
        {% endif %}
    </div>

    <div class="col-6 col-md-4 mb-3">
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-calendar-month"></i></span>
            <select id="month-select" class="form-select" {% if disable_month %}disabled{% endif %}>
                {% for month in available_months %}
                <option value="{{ month['num'] }}" {% if month['num']==selected_month %}selected{% endif %}>
                    {{ month['name'] }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="col-6 col-md-4 mb-3">
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
            <select id="year-select" class="form-select" {% if disable_year %}disabled{% endif %}>
                {% for year in available_years %}
                <option value="{{ year }}" {% if year==selected_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="input-group">
            <button id="clear-filters" type="button" class="btn btn-warning form-control">
                {{ _('Remove filters') }} <i class="bi bi-funnel"></i>
            </button>
        </div>
    </div>

    <!-- Tabla de Asistencia -->
    <div id="report-container" class="table-responsive mb-4" style="max-height: 600px; overflow-y: auto;">
        {% include "partials/attendance_table.html" %}
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const monthSelect = document.getElementById("month-select");
        const yearSelect = document.getElementById("year-select");
        const clearFilters = document.getElementById("clear-filters");
        const reportContainer = document.getElementById("report-container");
        const totalMembersElement = document.getElementById("total-members"); // Suponiendo que tienes un elemento con este ID en tu HTML.
    
        function applyFilters() {
            const selectedMonth = monthSelect.value;
            const selectedYear = yearSelect.value;
    
            fetch(`/attendance/report?year=${selectedYear}&month=${selectedMonth}`, {
                method: "GET",
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
                .then(response => {
                    if (!response.ok) throw new Error("Error en la respuesta del servidor");
                    return response.text();
                })
                .then(html => {
                    // Actualizar la tabla
                    reportContainer.innerHTML = html;
    
                    // Actualizar el total de miembros
                    const totalMiembros = document.getElementById("total-members-count").textContent;  // Asegúrate de que el total se pase como parte de la respuesta
                    totalMembersElement.textContent = totalMiembros; // Actualiza el total de miembros en la página
                })
                .catch(error => console.error("Error al cargar los datos:", error));
        }
    
        monthSelect.addEventListener("change", applyFilters);
        yearSelect.addEventListener("change", applyFilters);
    
        clearFilters.addEventListener("click", function () {
            fetch("/attendance/report", {
                method: "GET",
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
                .then(response => {
                    if (!response.ok) throw new Error("Error en la respuesta del servidor");
                    return response.text();
                })
                .then(html => {
                    reportContainer.innerHTML = html;
                    monthSelect.value = "";
                    yearSelect.value = "";
                })
                .catch(error => console.error("Error al limpiar los filtros:", error));
        });
    });
    
</script>

{% endblock %}