{% extends "layout.html" %}

{% block title %}{{ _('Attendance | Report') }}{% endblock %}

{% block content %}

    <h2 class="mb-3"><i class="bi bi-file-earmark-spreadsheet"></i>  {{ _('Attendance Report') }}</h2>
    <p class="mb-3">{{ meeting_center_name }}</p>

    <!-- Filtros -->
    <div class="row mb-3 p-3">
        <p>{{ _('Total Members') }}: <b>{{ total_miembros }} </b></p>
        <div class="input-group col-md">
            <span class="input-group-text"><i class="bi bi-calendar-month"></i></span>            
            <select id="month-select" class="form-select" {% if disable_month %}disabled{% endif %}>
                {% for month in available_months %}
                <option value="{{ month['num'] }}" {% if month['num'] == selected_month %}selected{% endif %}>
                    {{ month['name'] }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="input-group col-md">
            <span class="input-group-text"><i class="bi bi-calendar3"></i></span>  
            <select id="year-select" class="form-select" {% if disable_year %}disabled{% endif %}>
                {% for year in available_years %}
                <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="input-group col-md">
            <button id="clear-filters" type="button" class="btn btn-warning form-control">
                {{ _('Remove filters') }} <i class="bi bi-funnel"></i>
            </button>

        </div>
    </div>

    <!-- Tabla de Asistencia -->
    <div id="report-container" class="table-responsive" style="max-height: 500px; overflow-y: auto;">
        {% include "partials/attendance_table.html" %}
    </div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const monthSelect = document.getElementById("month-select");
        const yearSelect = document.getElementById("year-select");
        const clearFilters = document.getElementById("clear-filters");
        const reportContainer = document.getElementById("report-container");

        function applyFilters() {
            const selectedMonth = monthSelect.value;
            const selectedYear = yearSelect.value;

            fetch(`/attendance/report?year=${selectedYear}&month=${selectedMonth}`, {
                method: "GET",
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
            .then(response => {
                if (!response.ok) throw new Error("Error en la respuesta del servidor");
                return response.text();
            })
            .then(html => {
                reportContainer.innerHTML = html;
            })
            .catch(error => console.error("Error al cargar los datos:", error));
        }

        monthSelect.addEventListener("change", applyFilters);
        yearSelect.addEventListener("change", applyFilters);

        clearFilters.addEventListener("click", function () {
            fetch("/attendance/report", {
                method: "GET",
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
            .then(response => {
                if (!response.ok) throw new Error("Error en la respuesta del servidor");
                return response.text();
            })
            .then(html => {
                reportContainer.innerHTML = html;
                monthSelect.value = "";
                yearSelect.value = "";
            })
            .catch(error => console.error("Error al limpiar los filtros:", error));
        });
    });
</script>

{% endblock %}