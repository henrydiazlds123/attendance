{% extends "layout.html" %}
{% block head %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
{% block title %}Attendance | Admin {% endblock %}

{% block pageTitle %}{{ _('Welcome to the Attendance Management System') }}{% endblock %}
{% block content %}

<!-- Selector de Meeting Centers -->
<select id="meetingCenterSelector">
    <option value="all">{{ _('All Meeting Centers') }}</option>
</select>

<!-- Contenedor para la tabla de correcciones de nombres -->
<div class="container my-4">
    <h3>Name Corrections</h3>
    <div id="loading-spinner" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
    <div id="name-corrections-container">
        {% include 'partials/name_correction_table.html' %}
    </div>
</div>

<!-- Script para actualizar la tabla dinámicamente -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const meetingCenterSelector = document.getElementById('meetingCenterSelector');
    const nameCorrectionsContainer = document.getElementById('name-corrections-container');
    const spinner = document.getElementById('loading-spinner');

    function updateNameCorrectionsTable(meetingCenterId) {
        spinner.style.display = 'block'; // Mostrar spinner

        fetch(`/admin/name_corrections/filter?meeting_center_id=${meetingCenterId}`, {
            method: "GET",
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
            .then(response => {
                if (!response.ok) throw new Error("Error en la respuesta del servidor");
                return response.text();
            })
            .then(html => {
                nameCorrectionsContainer.innerHTML = html;
            })
            .catch(error => {
                console.error("Error al cargar los datos:", error);
                nameCorrectionsContainer.innerHTML = '<div class="alert alert-danger">Error al cargar los datos. Inténtalo de nuevo.</div>';
            })
            .finally(() => {
                spinner.style.display = 'none'; // Ocultar spinner
            });
    }

    meetingCenterSelector.addEventListener('change', function () {
        const selectedMeetingCenterId = this.value;
        localStorage.setItem('selectedMeetingCenterId', selectedMeetingCenterId);
        updateNameCorrectionsTable(selectedMeetingCenterId);
    });

    // Llamada a la API para obtener todos los meeting centers
    fetch("/meeting_center/api")
        .then(response => response.json())
        .then(data => {
            meetingCenterSelector.innerHTML = '<option value="all">{{ _("All Meeting Centers") }}</option>';

            data.forEach(meetingCenter => {
                const option = document.createElement('option');
                option.value = meetingCenter.id;
                option.textContent = meetingCenter.name;
                meetingCenterSelector.appendChild(option);
            });

            // Establecer el meeting center seleccionado desde localStorage
            const selectedMeetingCenterId = localStorage.getItem('selectedMeetingCenterId') || 'all';
            meetingCenterSelector.value = selectedMeetingCenterId;

            // Actualizar la tabla al cargar la página
            updateNameCorrectionsTable(selectedMeetingCenterId);
        })
        .catch(error => console.error('Error fetching meeting centers:', error));
});

function submitVerificationForm() {
    document.getElementById('verificationForm').submit();
}

function submitBypassForm() {
    document.getElementById('bypassForm').submit();
}
</script>

{% endblock %}